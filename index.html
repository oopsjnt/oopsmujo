<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="Oops Transportes Caramujo - Transporte r√°pido e seguro para o seu bairro">
    <title>Oops Transportes Caramujo</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <!-- Firebase App (a base) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Adicione os produtos Firebase que voc√™ quer usar -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>Oops Transportes Caramujo</h1>
            <p>Transporte r√°pido e seguro para o seu bairro</p>
            <button id="toggle-theme-button" class="theme-toggle">
                <span class="light-icon">‚òÄÔ∏è</span>
                <span class="dark-icon">üåô</span>
            </button>
        </header>

        <!-- Se√ß√£o de Login/Cadastro (Vis√≠vel inicialmente) -->
        <section id="auth-section" class="auth-section">
            <div class="tabs">
                <button id="login-tab" class="tab active">Login</button>
                <button id="register-tab" class="tab">Cadastro</button>
            </div>
            
            <!-- Formul√°rio de Login -->
            <div id="login-form" class="form-container">
                <h2>Entrar na sua conta</h2>
                <div class="form-group">
                    <label for="login-email">Email:</label>
                    <input type="email" id="login-email" placeholder="Seu email">
                </div>
                <div class="form-group">
                    <label for="login-password">Senha:</label>
                    <input type="password" id="login-password" placeholder="Sua senha">
                </div>
                <div class="form-group">
                    <button id="login-button" class="primary-button">Entrar</button>
                </div>
            </div>
            
            <!-- Formul√°rio de Cadastro -->
            <div id="register-form" class="form-container hidden">
                <h2>Criar nova conta</h2>
                <div class="form-group">
                    <label for="register-name">Nome completo:</label>
                    <input type="text" id="register-name" placeholder="Seu nome completo">
                </div>
                <div class="form-group">
                    <label for="register-phone">Telefone:</label>
                    <input type="tel" id="register-phone" placeholder="Seu telefone com DDD">
                </div>
                <div class="form-group">
                    <label for="register-email">Email:</label>
                    <input type="email" id="register-email" placeholder="Seu email">
                </div>
                <div class="form-group">
                    <label for="register-password">Senha:</label>
                    <input type="password" id="register-password" placeholder="Crie uma senha">
                </div>
                <div class="form-group">
                    <label>Tipo de conta:</label>
                    <div class="radio-group">
                        <input type="radio" id="user-type" name="account-type" value="user" checked>
                        <label for="user-type">Passageiro</label>
                        
                        <input type="radio" id="driver-type" name="account-type" value="driver">
                        <label for="driver-type">Mototaxista</label>
                    </div>
                </div>
                <div class="form-group">
                    <button id="register-button" class="primary-button">Cadastrar</button>
                </div>
            </div>
        </section>

        <!-- Se√ß√£o Principal do App (Escondida at√© login) -->
        <section id="app-section" class="app-section hidden">
            <!-- Conte√∫do do App ser√° carregado dinamicamente baseado no tipo de usu√°rio -->
            <div class="user-info">
                <div class="user-profile">
                    <img id="user-profile-picture" src="icons/default-profile.png" alt="Foto de perfil">
                    <p>Ol√°, <span id="user-name">Usu√°rio</span>!</p>
                </div>
                <div id="user-rating" class="user-rating"></div>
                <div class="user-actions">
                    <button id="profile-button" class="secondary-button">Perfil</button>
                    <button id="logout-button" class="secondary-button">Sair</button>
                </div>
            </div>
            
            <!-- Se√ß√£o de Perfil (Escondida inicialmente) -->
            <section id="profile-section" class="profile-section hidden">
                <h2>Seu Perfil</h2>
                <div class="profile-picture-container">
                    <img id="profile-picture-preview" src="icons/default-profile.png" alt="Foto de perfil">
                    <label for="profile-picture" class="upload-button">Alterar foto</label>
                    <input type="file" id="profile-picture" accept="image/*" class="hidden">
                </div>
                <div class="form-group">
                    <label for="profile-name">Nome:</label>
                    <input type="text" id="profile-name" placeholder="Seu nome completo">
                </div>
                <div class="form-group">
                    <label for="profile-phone">Telefone:</label>
                    <input type="tel" id="profile-phone" placeholder="Seu telefone com DDD">
                </div>
                <div class="form-group">
                    <button id="save-profile-button" class="primary-button">Salvar Perfil</button>
                    <button id="back-from-profile-button" class="secondary-button">Voltar</button>
                </div>
            </section>
            
            <!-- Interface do Passageiro -->
            <div id="passenger-interface" class="interface-container hidden">
                <h2>Solicitar Corrida</h2>
                <div class="form-group">
                    <label for="pickup-location">Onde voc√™ est√°?</label>
                    <input type="text" id="pickup-location" placeholder="Ex: Rua das Flores, 123">
                    <button id="use-current-location" class="secondary-button">Usar minha localiza√ß√£o atual</button>
                    <p id="location-status" class="status-text hidden"></p>
                </div>
                <div class="form-group">
                    <label for="destination">Para onde deseja ir?</label>
                    <input type="text" id="destination" placeholder="Ex: Shopping Center">
                </div>
                <div class="form-group">
                    <button id="request-ride-button" class="primary-button">Solicitar Motot√°xi</button>
                </div>
                
                <!-- Mototaxistas pr√≥ximos -->
                <div id="nearby-drivers" class="nearby-drivers"></div>
                
                <!-- Status da corrida -->
                <div id="ride-status" class="status-container hidden">
                    <h3>Status da sua corrida</h3>
                    <p id="status-message">Procurando mototaxistas pr√≥ximos...</p>
                    <div class="ride-actions">
                        <button id="cancel-ride-button" class="secondary-button" data-ride-id="">Cancelar Corrida</button>
                    </div>
                </div>
                
                <!-- Contato WhatsApp -->
                <div id="whatsapp-contact" class="whatsapp-container hidden"></div>
                
                <!-- Hist√≥rico de viagens -->
                <div id="ride-history" class="history-section"></div>
                
                <!-- Hist√≥rico de avalia√ß√µes -->
                <div class="ratings-section">
                    <h3>Minhas Avalia√ß√µes</h3>
                    <div id="user-ratings-history" class="ratings-history"></div>
                </div>
            </div>
            
            <!-- Interface do Mototaxista -->
            <div id="driver-interface" class="interface-container hidden">
                <h2>Painel do Mototaxista</h2>
                <div class="status-toggle">
                    <label for="driver-status">Status:</label>
                    <select id="driver-status">
                        <option value="available">Dispon√≠vel</option>
                        <option value="unavailable">Indispon√≠vel</option>
                    </select>
                </div>
                
                <div id="available-rides" class="rides-container">
                    <h3>Corridas Dispon√≠veis</h3>
                    <div id="rides-list" class="rides-list">
                        <!-- As corridas ser√£o adicionadas dinamicamente aqui -->
                        <p class="empty-message">Nenhuma corrida dispon√≠vel no momento.</p>
                    </div>
                </div>
                
                <div id="current-ride" class="current-ride hidden">
                    <h3>Corrida Atual</h3>
                    <div class="ride-details">
                        <p><strong>Passageiro:</strong> <span id="passenger-name">-</span></p>
                        <p><strong>Local de partida:</strong> <span id="ride-pickup">-</span></p>
                        <p><strong>Destino:</strong> <span id="ride-destination">-</span></p>
                    </div>
                    <div class="ride-actions">
                        <button id="complete-ride-button" class="primary-button">Finalizar Corrida</button>
                    </div>
                </div>
                
                <!-- Contato WhatsApp -->
                <div id="whatsapp-contact" class="whatsapp-container hidden"></div>
                
                <!-- Hist√≥rico de viagens -->
                <div id="ride-history" class="history-section"></div>
                
                <!-- Hist√≥rico de avalia√ß√µes -->
                <div class="ratings-section">
                    <h3>Minhas Avalia√ß√µes</h3>
                    <div id="driver-ratings-history" class="ratings-history"></div>
                </div>
            </div>
        </section>
        
        <!-- Banner de instala√ß√£o do PWA -->
        <div id="pwa-install-banner" class="pwa-banner hidden">
            <p>Instale nosso app para uma experi√™ncia melhor!</p>
            <button id="pwa-install-button" class="primary-button">Instalar</button>
            <button id="pwa-close-button" class="secondary-button">Agora n√£o</button>
        </div>
    </div>

    <script src="geo-service.js"></script>
    <script src="rating-service.js"></script>
    <script src="script.js"></script>
    <script>
        // Registrar o Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration);
                    })
                    .catch(error => {
                        console.error('Erro ao registrar Service Worker:', error);
                    });
            });
        }
        
        // Vari√°veis para o banner de instala√ß√£o do PWA
        let deferredPrompt;
        const pwaInstallBanner = document.getElementById('pwa-install-banner');
        const pwaInstallButton = document.getElementById('pwa-install-button');
        const pwaCloseButton = document.getElementById('pwa-close-button');
        
        // Evento disparado antes do prompt de instala√ß√£o
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevenir o prompt autom√°tico
            e.preventDefault();
            // Armazenar o evento para uso posterior
            deferredPrompt = e;
            // Mostrar o banner de instala√ß√£o
            pwaInstallBanner.classList.remove('hidden');
        });
        
        // Bot√£o de instala√ß√£o
        pwaInstallButton.addEventListener('click', () => {
            // Esconder o banner
            pwaInstallBanner.classList.add('hidden');
            // Mostrar o prompt de instala√ß√£o
            deferredPrompt.prompt();
            // Esperar pela escolha do usu√°rio
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('Usu√°rio aceitou a instala√ß√£o do PWA');
                } else {
                    console.log('Usu√°rio recusou a instala√ß√£o do PWA');
                }
                // Limpar a refer√™ncia
                deferredPrompt = null;
            });
        });
        
        // Bot√£o para fechar o banner
        pwaCloseButton.addEventListener('click', () => {
            pwaInstallBanner.classList.add('hidden');
        });
        
        // Alternar tema
        const toggleThemeButton = document.getElementById('toggle-theme-button');
        if (toggleThemeButton) {
            toggleThemeButton.addEventListener('click', () => {
                if (document.body.classList.contains('dark-theme')) {
                    document.body.classList.remove('dark-theme');
                    localStorage.setItem('theme', 'light');
                } else {
                    document.body.classList.add('dark-theme');
                    localStorage.setItem('theme', 'dark');
                }
            });
        }
        
        // Bot√µes de perfil
        const profileButton = document.getElementById('profile-button');
        const backFromProfileButton = document.getElementById('back-from-profile-button');
        const profileSection = document.getElementById('profile-section');
        const passengerInterface = document.getElementById('passenger-interface');
        const driverInterface = document.getElementById('driver-interface');
        
        if (profileButton && profileSection) {
            profileButton.addEventListener('click', () => {
                profileSection.classList.remove('hidden');
                passengerInterface.classList.add('hidden');
                driverInterface.classList.add('hidden');
            });
        }
        
        if (backFromProfileButton && profileSection) {
            backFromProfileButton.addEventListener('click', () => {
                profileSection.classList.add('hidden');
                // Verificar qual interface mostrar
                if (currentUser) {
                    db.collection("users").doc(currentUser.uid).get()
                        .then((doc) => {
                            if (doc.exists) {
                                const userData = doc.data();
                                if (userData.accountType === "user") {
                                    passengerInterface.classList.remove('hidden');
                                } else {
                                    driverInterface.classList.remove('hidden');
                                }
                            }
                        });
                }
            });
        }
    </script>
</body>
</html>
