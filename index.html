<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="Oops Transportes Caramujo - Transporte r√°pido e seguro para o seu bairro">
    <title>Oops Transportes Caramujo</title>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192x192.png">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <!-- Firebase App (a base) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <!-- Adicione os produtos Firebase que voc√™ quer usar -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
</head>
<body class="dark-theme">
    <div class="container">
        <header>
            <h1>Oops Transportes Caramujo</h1>
            <p>Transporte r√°pido e seguro para o seu bairro</p>
            <button id="toggle-theme-button" class="theme-toggle">
                <span class="light-icon">‚òÄÔ∏è</span>
                <span class="dark-icon">üåô</span>
            </button>
        </header>

        <!-- Se√ß√£o de Login/Cadastro (Vis√≠vel inicialmente) -->
        <section id="auth-section" class="auth-section">
            <div class="tabs">
                <button id="login-tab" class="tab active">Login</button>
                <button id="register-tab" class="tab">Cadastro</button>
            </div>
            
            <!-- Formul√°rio de Login -->
            <div id="login-form" class="form-container">
                <h2>Entrar na sua conta</h2>
                <div class="form-group">
                    <label for="login-email">Email:</label>
                    <input type="email" id="login-email" placeholder="Seu email">
                </div>
                <div class="form-group">
                    <label for="login-password">Senha:</label>
                    <input type="password" id="login-password" placeholder="Sua senha">
                </div>
                <div class="form-group">
                    <button id="login-button" class="primary-button">Entrar</button>
                </div>
            </div>
            
            <!-- Formul√°rio de Cadastro -->
            <div id="register-form" class="form-container hidden">
                <h2>Criar nova conta</h2>
                
                <!-- Termos de Uso -->
                <div class="terms-container">
                    <div class="terms-text">
                        <h3>Termos de Uso</h3>
                        <p>Ao se cadastrar, voc√™ concorda que nosso sistema √© apenas um intermedi√°rio entre passageiros e mototaxistas. N√£o nos responsabilizamos por:</p>
                        <ul>
                            <li>Documenta√ß√£o dos condutores</li>
                            <li>Estado dos ve√≠culos</li>
                            <li>Perdas ou danos durante o transporte</li>
                            <li>Acidentes ou incidentes</li>
                        </ul>
                        <p>O usu√°rio utiliza o servi√ßo por sua pr√≥pria conta e risco.</p>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-container">
                            <input type="checkbox" id="accept-terms" required>
                            <span class="checkmark"></span>
                            Aceito os termos de uso
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="register-name">Nome completo:</label>
                    <input type="text" id="register-name" placeholder="Seu nome completo">
                </div>
                <div class="form-group">
                    <label for="register-phone">Telefone:</label>
                    <input type="tel" id="register-phone" placeholder="Seu telefone com DDD">
                </div>
                <div class="form-group">
                    <label for="register-email">Email:</label>
                    <input type="email" id="register-email" placeholder="Seu email">
                </div>
                <div class="form-group">
                    <label for="register-password">Senha:</label>
                    <input type="password" id="register-password" placeholder="Crie uma senha">
                </div>
                <div class="form-group">
                    <label>Tipo de conta:</label>
                    <div class="radio-group">
                        <input type="radio" id="user-type" name="account-type" value="user" checked>
                        <label for="user-type">Passageiro</label>
                        
                        <input type="radio" id="driver-type" name="account-type" value="driver">
                        <label for="driver-type">Mototaxista</label>
                    </div>
                </div>
                <div class="form-group">
                    <button id="register-button" class="primary-button">Cadastrar</button>
                </div>
            </div>
        </section>

        <!-- Se√ß√£o Principal do App (Escondida at√© login) -->
        <section id="app-section" class="app-section hidden">
            <!-- Conte√∫do do App ser√° carregado dinamicamente baseado no tipo de usu√°rio -->
            <div class="user-info">
                <div class="user-profile">
                    <img id="user-profile-picture" src="icons/default-profile.png" alt="Foto de perfil">
                    <p>Ol√°, <span id="user-name">Usu√°rio</span>!</p>
                </div>
                <div id="user-rating" class="user-rating"></div>
                <div class="user-actions">
                    <button id="profile-button" class="secondary-button">Perfil</button>
                    <button id="logout-button" class="secondary-button">Sair</button>
                </div>
            </div>
            
            <!-- Navega√ß√£o principal -->
            <div class="main-nav">
                <button id="nav-main" class="nav-button active">Principal</button>
                <button id="nav-profile" class="nav-button">Perfil</button>
                <button id="nav-history" class="nav-button">Hist√≥rico</button>
                <button id="nav-suggestions" class="nav-button">Sugest√µes</button>
                <button id="nav-admin" class="nav-button hidden">Admin</button>
                <button id="nav-pricing" class="nav-button">Pre√ßos</button>
                <button id="nav-payments" class="nav-button hidden">Pagamentos</button>
            </div>
            
            <!-- Se√ß√£o de Perfil -->
            <section id="profile-section" class="content-section hidden">
                <h2>Seu Perfil</h2>
                <div class="profile-picture-container">
                    <img id="profile-picture-preview" src="icons/default-profile.png" alt="Foto de perfil">
                    <label for="profile-picture" class="upload-button">Alterar foto</label>
                    <input type="file" id="profile-picture" accept="image/*" class="hidden">
                </div>
                <div class="form-group">
                    <label for="profile-name">Nome:</label>
                    <input type="text" id="profile-name" placeholder="Seu nome completo">
                </div>
                <div class="form-group">
                    <label for="profile-phone">Telefone:</label>
                    <input type="tel" id="profile-phone" placeholder="Seu telefone com DDD">
                </div>
                <div class="form-group">
                    <button id="save-profile-button" class="primary-button">Salvar Perfil</button>
                </div>
            </section>
            
            <!-- Se√ß√£o de Hist√≥rico -->
            <section id="history-section" class="content-section hidden">
                <h2>Hist√≥rico de Viagens</h2>
                <div id="ride-history" class="history-section">
                    <p class="loading-message">Carregando hist√≥rico...</p>
                </div>
                
                <!-- Hist√≥rico de avalia√ß√µes -->
                <div class="ratings-section">
                    <h3>Minhas Avalia√ß√µes</h3>
                    <div id="user-ratings-history" class="ratings-history">
                        <p class="loading-message">Carregando avalia√ß√µes...</p>
                    </div>
                </div>
            </section>
            
            <!-- Se√ß√£o de Sugest√µes -->
            <section id="suggestions-section" class="content-section hidden">
                <h2>Sugest√µes e Melhorias</h2>
                <div class="form-group">
                    <label for="suggestion-title">T√≠tulo:</label>
                    <input type="text" id="suggestion-title" placeholder="T√≠tulo da sua sugest√£o">
                </div>
                <div class="form-group">
                    <label for="suggestion-text">Descri√ß√£o:</label>
                    <textarea id="suggestion-text" rows="5" placeholder="Descreva sua sugest√£o ou melhoria para o aplicativo"></textarea>
                </div>
                <div class="form-group">
                    <label for="suggestion-type">Tipo:</label>
                    <select id="suggestion-type">
                        <option value="improvement">Melhoria</option>
                        <option value="bug">Corre√ß√£o de Bug</option>
                        <option value="feature">Nova Funcionalidade</option>
                        <option value="other">Outro</option>
                    </select>
                </div>
                <div class="form-group">
                    <button id="submit-suggestion-button" class="primary-button">Enviar Sugest√£o</button>
                </div>
                
                <div class="suggestions-list-container">
                    <h3>Minhas Sugest√µes Enviadas</h3>
                    <div id="suggestions-list" class="suggestions-list">
                        <p class="loading-message">Carregando sugest√µes...</p>
                    </div>
                </div>
            </section>
            
            <!-- Se√ß√£o de Administra√ß√£o -->
            <section id="admin-section" class="content-section hidden">
                <h2>Painel de Administra√ß√£o</h2>
                
                <!-- Estat√≠sticas Gerais -->
                <div class="admin-stats">
                    <div class="stat-card">
                        <h3>Usu√°rios Cadastrados</h3>
                        <p id="total-users" class="stat-number">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>Total de Viagens</h3>
                        <p id="total-rides" class="stat-number">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>Sugest√µes Recebidas</h3>
                        <p id="total-suggestions" class="stat-number">-</p>
                    </div>
                    <div class="stat-card">
                        <h3>Avalia√ß√µes</h3>
                        <p id="total-ratings" class="stat-number">-</p>
                    </div>
                </div>
                
                <!-- Gest√£o de Usu√°rios -->
                <div class="admin-section-content">
                    <h3>Gest√£o de Usu√°rios</h3>
                    <div id="users-management" class="users-list">
                        <p class="loading-message">Carregando usu√°rios...</p>
                    </div>
                </div>
                
                <!-- Sugest√µes e Reclama√ß√µes -->
                <div class="admin-section-content">
                    <h3>Sugest√µes e Reclama√ß√µes</h3>
                    <div id="admin-suggestions" class="suggestions-admin">
                        <p class="loading-message">Carregando sugest√µes...</p>
                    </div>
                </div>
                
                <!-- Avalia√ß√µes -->
                <div class="admin-section-content">
                    <h3>Avalia√ß√µes do Sistema</h3>
                    <div id="admin-ratings" class="ratings-admin">
                        <p class="loading-message">Carregando avalia√ß√µes...</p>
                    </div>
                </div>
            </section>
            
            <!-- Se√ß√£o de Pre√ßos -->
            <section id="pricing-section" class="content-section hidden">
                <h2>Tabela de Pre√ßos</h2>
                <div id="pricing-content" class="pricing-content">
                    <p class="loading-message">Carregando tabela de pre√ßos...</p>
                </div>
                
                <!-- √Årea para administradores atualizarem a tabela -->
                <div id="pricing-admin" class="pricing-admin hidden">
                    <h3>Atualizar Tabela de Pre√ßos</h3>
                    <div class="form-group">
                        <label for="pricing-image">Imagem da Tabela de Pre√ßos:</label>
                        <input type="file" id="pricing-image" accept="image/*">
                        <button id="upload-pricing-button" class="primary-button">Atualizar Tabela</button>
                    </div>
                </div>
            </section>
            
            <!-- Se√ß√£o de Pagamentos (para mototaxistas) -->
            <section id="payments-section" class="content-section hidden">
                <h2>Pagamentos</h2>
                <div class="payment-info">
                    <p>Sistema de pagamento semanal para acesso √† plataforma.</p>
                    <div class="payment-status">
                        <h3>Status do Pagamento</h3>
                        <p id="payment-status">Verificando status...</p>
                    </div>
                    <div class="payment-history">
                        <h3>Hist√≥rico de Pagamentos</h3>
                        <div id="payment-history-list">
                            <p class="loading-message">Carregando hist√≥rico...</p>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Interface do Passageiro -->
            <div id="passenger-interface" class="interface-container content-section hidden">
                <h2>Solicitar Corrida</h2>
                
                <!-- Tipo de Servi√ßo -->
                <div class="form-group">
                    <label>Tipo de servi√ßo:</label>
                    <div class="radio-group">
                        <input type="radio" id="service-passenger" name="service-type" value="passenger" checked>
                        <label for="service-passenger">Passageiro</label>
                        
                        <input type="radio" id="service-delivery" name="service-type" value="delivery">
                        <label for="service-delivery">Entrega</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="pickup-location">Onde voc√™ est√°?</label>
                    <input type="text" id="pickup-location" placeholder="Ex: Rua das Flores, 123">
                    <button id="use-current-location" class="secondary-button">Usar minha localiza√ß√£o atual</button>
                    <p id="location-status" class="status-text hidden"></p>
                </div>
                <div class="form-group">
                    <label for="destination">Para onde deseja ir?</label>
                    <input type="text" id="destination" placeholder="Ex: Shopping Center">
                </div>
                <div class="form-group">
                    <button id="request-ride-button" class="primary-button">Solicitar Motot√°xi</button>
                </div>
                
                <!-- Mototaxistas pr√≥ximos -->
                <div id="nearby-drivers" class="nearby-drivers">
                    <h3>Mototaxistas Dispon√≠veis</h3>
                    <div id="drivers-list" class="drivers-list">
                        <p class="empty-message">Nenhum mototaxista dispon√≠vel no momento.</p>
                    </div>
                </div>
                
                <!-- Status da corrida -->
                <div id="ride-status" class="status-container hidden">
                    <h3>Status da sua corrida</h3>
                    <p id="status-message">Procurando mototaxistas pr√≥ximos...</p>
                    <div class="ride-actions">
                        <button id="cancel-ride-button" class="secondary-button" data-ride-id="">Cancelar Corrida</button>
                    </div>
                </div>
                
                <!-- Contato WhatsApp -->
                <div id="whatsapp-contact" class="whatsapp-container hidden"></div>
            </div>
            
            <!-- Interface do Mototaxista -->
            <div id="driver-interface" class="interface-container content-section hidden">
                <h2>Painel do Mototaxista</h2>
                <div class="status-toggle">
                    <label for="driver-status">Status:</label>
                    <select id="driver-status">
                        <option value="available">Dispon√≠vel</option>
                        <option value="unavailable">Indispon√≠vel</option>
                    </select>
                </div>
                
                <div id="available-rides" class="rides-container">
                    <h3>Corridas Dispon√≠veis</h3>
                    <div id="rides-list" class="rides-list">
                        <!-- As corridas ser√£o adicionadas dinamicamente aqui -->
                        <p class="empty-message">Nenhuma corrida dispon√≠vel no momento.</p>
                    </div>
                </div>
                
                <div id="current-ride" class="current-ride hidden">
                    <h3>Corrida Atual</h3>
                    <div class="ride-details">
                        <p><strong>Passageiro:</strong> <span id="passenger-name">-</span></p>
                        <p><strong>Local de partida:</strong> <span id="ride-pickup">-</span></p>
                        <p><strong>Destino:</strong> <span id="ride-destination">-</span></p>
                    </div>
                    <div class="ride-actions">
                        <button id="complete-ride-button" class="primary-button">Finalizar Corrida</button>
                    </div>
                </div>
                
                <!-- Contato WhatsApp -->
                <div id="whatsapp-contact-driver" class="whatsapp-container hidden"></div>
            </div>
        </section>
        
        <!-- Banner de instala√ß√£o do PWA -->
        <div id="pwa-install-banner" class="pwa-banner hidden">
            <p>Instale nosso app para uma experi√™ncia melhor!</p>
            <button id="pwa-install-button" class="primary-button">Instalar</button>
            <button id="pwa-close-button" class="secondary-button">Agora n√£o</button>
        </div>
    </div>

    <script src="geo-service.js"></script>
    <script src="rating-service.js"></script>
    <script src="script.js"></script>
    <script>
        // Registrar o Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration);
                    })
                    .catch(error => {
                        console.error('Erro ao registrar Service Worker:', error);
                    });
            });
        }
        
        // Vari√°veis para o banner de instala√ß√£o do PWA
        let deferredPrompt;
        const pwaInstallBanner = document.getElementById('pwa-install-banner');
        const pwaInstallButton = document.getElementById('pwa-install-button');
        const pwaCloseButton = document.getElementById('pwa-close-button');
        
        // Evento disparado antes do prompt de instala√ß√£o
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevenir o prompt autom√°tico
            e.preventDefault();
            // Armazenar o evento para uso posterior
            deferredPrompt = e;
            // Mostrar o banner de instala√ß√£o
            pwaInstallBanner.classList.remove('hidden');
        });
        
        // Bot√£o de instala√ß√£o
        pwaInstallButton.addEventListener('click', () => {
            // Esconder o banner
            pwaInstallBanner.classList.add('hidden');
            // Mostrar o prompt de instala√ß√£o
            deferredPrompt.prompt();
            // Esperar pela escolha do usu√°rio
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('Usu√°rio aceitou a instala√ß√£o do PWA');
                } else {
                    console.log('Usu√°rio recusou a instala√ß√£o do PWA');
                }
                // Limpar a refer√™ncia
                deferredPrompt = null;
            });
        });
        
        // Bot√£o para fechar o banner
        pwaCloseButton.addEventListener('click', () => {
            pwaInstallBanner.classList.add('hidden');
        });
        
        // Alternar tema
        const toggleThemeButton = document.getElementById('toggle-theme-button');
        if (toggleThemeButton) {
            toggleThemeButton.addEventListener('click', () => {
                document.body.classList.toggle('dark-theme');
                localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
            });
        }
        
        // Aplicar tema salvo
        if (localStorage.getItem('theme') === 'light') {
            document.body.classList.remove('dark-theme');
        } else {
            document.body.classList.add('dark-theme');
        }
        
        // Navega√ß√£o principal
        const navMain = document.getElementById('nav-main');
        const navProfile = document.getElementById('nav-profile');
        const navHistory = document.getElementById('nav-history');
        const navSuggestions = document.getElementById('nav-suggestions');
        
        const passengerInterface = document.getElementById('passenger-interface');
        const driverInterface = document.getElementById('driver-interface');
        const profileSection = document.getElementById('profile-section');
        const historySection = document.getElementById('history-section');
        const suggestionsSection = document.getElementById('suggestions-section');
        
        function hideAllSections() {
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => section.classList.add('hidden'));
            
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach(button => button.classList.remove('active'));
        }
        
        navMain.addEventListener('click', () => {
            hideAllSections();
            navMain.classList.add('active');
            
            // Verificar qual interface mostrar
            if (currentUser) {
                db.collection("users").doc(currentUser.uid).get()
                    .then((doc) => {
                        if (doc.exists) {
                            const userData = doc.data();
                            if (userData.accountType === "user") {
                                passengerInterface.classList.remove('hidden');
                            } else {
                                driverInterface.classList.remove('hidden');
                            }
                        }
                    });
            }
        });
        
        navProfile.addEventListener('click', () => {
            hideAllSections();
            navProfile.classList.add('active');
            profileSection.classList.remove('hidden');
        });
        
        navHistory.addEventListener('click', () => {
            hideAllSections();
            navHistory.classList.add('active');
            historySection.classList.remove('hidden');
            
            // Carregar hist√≥rico
            if (currentUser) {
                db.collection("users").doc(currentUser.uid).get()
                    .then((doc) => {
                        if (doc.exists) {
                            const userData = doc.data();
                            loadRideHistory(userData.accountType);
                            
                            // Carregar avalia√ß√µes
                            const ratingsContainer = document.getElementById('user-ratings-history');
                            if (ratingsContainer && ratingService) {
                                ratingService.loadUserRatingsHistory(currentUser.uid, ratingsContainer);
                            }
                        }
                    });
            }
        });
        
        navSuggestions.addEventListener('click', () => {
            hideAllSections();
            navSuggestions.classList.add('active');
            suggestionsSection.classList.remove('hidden');
            
            // Carregar sugest√µes
            loadUserSuggestions();
        });
        
        // Bot√£o de enviar sugest√£o
        const submitSuggestionButton = document.getElementById('submit-suggestion-button');
        if (submitSuggestionButton) {
            submitSuggestionButton.addEventListener('click', () => {
                const title = document.getElementById('suggestion-title').value;
                const text = document.getElementById('suggestion-text').value;
                const type = document.getElementById('suggestion-type').value;
                
                if (!title || !text) {
                    alert('Por favor, preencha o t√≠tulo e a descri√ß√£o da sugest√£o.');
                    return;
                }
                
                if (currentUser) {
                    db.collection('suggestions').add({
                        userId: currentUser.uid,
                        userName: document.getElementById('user-name').textContent,
                        title: title,
                        text: text,
                        type: type,
                        status: 'pending',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    })
                    .then(() => {
                        alert('Sugest√£o enviada com sucesso!');
                        document.getElementById('suggestion-title').value = '';
                        document.getElementById('suggestion-text').value = '';
                        loadUserSuggestions();
                    })
                    .catch(error => {
                        console.error('Erro ao enviar sugest√£o:', error);
                        alert('Erro ao enviar sugest√£o: ' + error.message);
                    });
                }
            });
        }
        
        // Fun√ß√£o para carregar sugest√µes do usu√°rio
        function loadUserSuggestions() {
            const suggestionsList = document.getElementById('suggestions-list');
            if (!suggestionsList || !currentUser) return;
            
            suggestionsList.innerHTML = '<p class="loading-message">Carregando sugest√µes...</p>';
            
            db.collection('suggestions')
                .where('userId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get()
                .then(querySnapshot => {
                    suggestionsList.innerHTML = '';
                    
                    if (querySnapshot.empty) {
                        suggestionsList.innerHTML = '<p class="empty-message">Voc√™ ainda n√£o enviou nenhuma sugest√£o.</p>';
                        return;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const suggestion = doc.data();
                        const suggestionItem = document.createElement('div');
                        suggestionItem.className = 'suggestion-item';
                        
                        const date = suggestion.createdAt ? suggestion.createdAt.toDate().toLocaleDateString('pt-BR') : 'Data indispon√≠vel';
                        
                        let statusText = 'Pendente';
                        let statusClass = 'status-pending';
                        
                        if (suggestion.status === 'approved') {
                            statusText = 'Aprovada';
                            statusClass = 'status-approved';
                        } else if (suggestion.status === 'rejected') {
                            statusText = 'Rejeitada';
                            statusClass = 'status-rejected';
                        } else if (suggestion.status === 'implemented') {
                            statusText = 'Implementada';
                            statusClass = 'status-implemented';
                        }
                        
                        suggestionItem.innerHTML = `
                            <div class="suggestion-header">
                                <h4>${suggestion.title}</h4>
                                <span class="suggestion-date">${date}</span>
                            </div>
                            <p class="suggestion-text">${suggestion.text}</p>
                            <div class="suggestion-footer">
                                <span class="suggestion-type">${suggestion.type}</span>
                                <span class="suggestion-status ${statusClass}">${statusText}</span>
                            </div>
                        `;
                        
                        suggestionsList.appendChild(suggestionItem);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar sugest√µes:', error);
                    suggestionsList.innerHTML = '<p class="error-message">Erro ao carregar sugest√µes.</p>';
                });
        }
    </script>
</body>
</html>
